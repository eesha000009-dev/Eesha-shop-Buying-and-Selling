<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - Eesha Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <!-- Centralized Supabase initializer -->
    <script src="../js/config/supabase.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
    <!-- Main Container -->
    <div class="w-full max-w-md">
        <!-- Logo -->
        <div class="text-center mb-8">
            <img src="../Eesha buying folder/shared/image1.svg" alt="Eesha Logo" class="mx-auto h-20">
            <h2 class="mt-4 text-3xl font-bold text-gray-900">Create your account</h2>
            <p class="mt-2 text-gray-600">Get started with Eesha Shop</p>
        </div>

        <!-- Signup Card -->
        <div class="bg-white shadow-xl rounded-lg p-8">
            <!-- Multi-step Form -->
            <form id="signupForm" class="space-y-6">
                <!-- Progress Steps -->
                <div class="flex justify-between items-center mb-8">
                    <div class="w-full flex items-center">
                        <div class="relative flex flex-col items-center flex-1">
                            <div class="w-6 h-6 bg-[#f0474a] rounded-full flex items-center justify-center text-white text-sm step-indicator" data-step="1">1</div>
                            <div class="text-xs mt-2">Account</div>
                        </div>
                        <div class="flex-1 h-1 bg-gray-200 step-line"></div>
                        <div class="relative flex flex-col items-center flex-1">
                            <div class="w-6 h-6 bg-gray-300 rounded-full flex items-center justify-center text-white text-sm step-indicator" data-step="2">2</div>
                            <div class="text-xs mt-2">Personal</div>
                        </div>
                        <div class="flex-1 h-1 bg-gray-200 step-line"></div>
                        <div class="relative flex flex-col items-center flex-1">
                            <div class="w-6 h-6 bg-gray-300 rounded-full flex items-center justify-center text-white text-sm step-indicator" data-step="3">3</div>
                            <div class="text-xs mt-2">Business</div>
                        </div>
                        <div class="flex-1 h-1 bg-gray-200 step-line"></div>
                        <div class="relative flex flex-col items-center flex-1">
                            <div class="w-6 h-6 bg-gray-300 rounded-full flex items-center justify-center text-white text-sm step-indicator" data-step="4">4</div>
                            <div class="text-xs mt-2">Preferences</div>
                        </div>
                    </div>
                </div>

                    <!-- Step 1: Account Information -->
                <div class="form-step" id="step1">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Account Setup</h3>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email address</label>
                        <input type="email" id="email" name="email" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#f0474a] focus:border-[#f0474a]">
                    </div>

                    <div class="mt-4">
                        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                        <div class="relative">
                            <input type="password" id="password" name="password" required minlength="8"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#f0474a] focus:border-[#f0474a]"
                                   pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&#+=])[A-Za-z\d@$!%*?&#+=]{8,}$">
                            <button type="button" 
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center" 
                                    onclick="togglePasswordVisibility('password')"
                                    aria-label="Toggle password visibility"
                                    title="Toggle password visibility">
                                <i class="fas fa-eye text-gray-400 hover:text-gray-600"></i>
                            </button>
                        </div>
                        <div class="mt-2 text-sm text-gray-600">
                            <p>Password must contain:</p>
                            <ul class="list-disc ml-5 mt-1 space-y-1">
                                <li>At least 8 characters</li>
                                <li>At least one uppercase letter (A-Z)</li>
                                <li>At least one lowercase letter (a-z)</li>
                                <li>At least one number (0-9)</li>
                                <li>At least one special character (@$!%*?&#+=)</li>
                            </ul>
                            <p class="mt-1">Example: "Shopping@123"</p>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label for="confirm_password" class="block text-sm font-medium text-gray-700">Confirm Password</label>
                        <div class="relative">
                            <input type="password" id="confirm_password" name="confirm_password" required minlength="8"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#f0474a] focus:border-[#f0474a]">
                            <button type="button" 
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center" 
                                    onclick="togglePasswordVisibility('confirm_password')"
                                    aria-label="Toggle confirm password visibility"
                                    title="Toggle confirm password visibility">
                                <i class="fas fa-eye text-gray-400 hover:text-gray-600"></i>
                            </button>
                        </div>
                    </div>
                </div>                <!-- Step 2: Personal Information -->
                <div class="form-step hidden" id="step2">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Personal Information</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="first_name" class="block text-sm font-medium text-gray-700">First Name</label>
                            <input type="text" id="first_name" name="first_name" required
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#f0474a] focus:border-[#f0474a]">
                        </div>
                        <div>
                            <label for="last_name" class="block text-sm font-medium text-gray-700">Last Name</label>
                            <input type="text" id="last_name" name="last_name" required
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#f0474a] focus:border-[#f0474a]">
                        </div>
                    </div>

                    <div class="mt-4">
                        <label for="contact_phone" class="block text-sm font-medium text-gray-700">Contact Phone</label>
                        <div class="flex">
                            <span class="inline-flex items-center px-3 text-gray-500 bg-gray-100 rounded-l-md border border-r-0 border-gray-300">
                                +234
                            </span>
                            <input type="tel" id="contact_phone" name="contact_phone" required
                                   class="mt-0 block w-full px-3 py-2 border border-gray-300 rounded-r-md shadow-sm focus:outline-none focus:ring-[#f0474a] focus:border-[#f0474a]">
                        </div>
                    </div>

                    <div class="mt-4">
                        <label for="profile_image" class="block text-sm font-medium text-gray-700">Profile Image</label>
                        <input type="file" id="profile_image" name="profile_image" accept="image/*"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#f0474a] focus:border-[#f0474a]">
                    </div>
                </div>

                <!-- Step 3: Business Information -->
                <div class="form-step hidden" id="step3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Business Information</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Account Type</label>
                        <div class="space-y-2">
                            <div class="flex items-center p-3 border rounded-md">
                                <input type="radio" id="business" name="account_type" value="business" required
                                       class="h-4 w-4 text-[#f0474a] focus:ring-[#f0474a]">
                                <label for="business" class="ml-3">
                                    <span class="block text-sm font-medium text-gray-900">Business</span>
                                    <span class="block text-sm text-gray-500">Registered company or organization</span>
                                </label>
                            </div>
                            <div class="flex items-center p-3 border rounded-md">
                                <input type="radio" id="individual" name="account_type" value="individual" required
                                       class="h-4 w-4 text-[#f0474a] focus:ring-[#f0474a]">
                                <label for="individual" class="ml-3">
                                    <span class="block text-sm font-medium text-gray-900">Individual</span>
                                    <span class="block text-sm text-gray-500">Personal or sole proprietorship</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label for="business_name" class="block text-sm font-medium text-gray-700">Business/Shop Name</label>
                        <input type="text" id="business_name" name="business_name" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#f0474a] focus:border-[#f0474a]">
                    </div>

                    <div class="mt-4">
                        <label for="business_description" class="block text-sm font-medium text-gray-700">Business Description</label>
                        <textarea id="business_description" name="business_description" rows="3"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#f0474a] focus:border-[#f0474a]"></textarea>
                    </div>

                    <div class="mt-4">
                        <label for="business_category" class="block text-sm font-medium text-gray-700">Business Category</label>
                        <select id="business_category" name="business_category" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#f0474a] focus:border-[#f0474a]">
                            <option value="">Select a category</option>
                            <option value="retail">Retail</option>
                            <option value="electronics">Electronics</option>
                            <option value="fashion">Fashion & Apparel</option>
                            <option value="home">Home & Garden</option>
                            <option value="beauty">Beauty & Personal Care</option>
                            <option value="food">Food & Beverages</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="mt-4">
                        <label for="business_location" class="block text-sm font-medium text-gray-700">Business Location</label>
                        <input type="text" id="business_location" name="business_location" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#f0474a] focus:border-[#f0474a]">
                    </div>

                    <div class="mt-4">
                        <label for="address" class="block text-sm font-medium text-gray-700">Address</label>
                        <input type="text" id="address" name="address" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#f0474a] focus:border-[#f0474a]">
                    </div>
                </div>

                <!-- Step 4: Preferences -->
                <div class="form-step hidden" id="step4">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Account Preferences</h3>
                    
                    <div>
                        <label for="language" class="block text-sm font-medium text-gray-700">Preferred Language</label>
                        <select id="language" name="language"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#f0474a] focus:border-[#f0474a]">
                            <option value="en">English</option>
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                        </select>
                    </div>

                    <div class="mt-6">
                        <div class="flex items-center">
                            <input type="checkbox" id="terms" name="terms" required
                                   class="h-4 w-4 text-[#f0474a] focus:ring-[#f0474a] border-gray-300 rounded">
                            <label for="terms" class="ml-2 block text-sm text-gray-900">
                                I agree to the <a href="#" class="text-[#f0474a] hover:underline">Terms and Conditions</a>
                                and <a href="#" class="text-[#f0474a] hover:underline">Privacy Policy</a>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Message Area -->
                <div id="messageArea" class="hidden text-sm text-center mb-4"></div>

                <!-- Navigation Buttons -->
                <div class="flex flex-col gap-4 mt-8">
                    <div class="flex justify-between gap-2">
                        <button type="button" id="prevButton"
                                class="hidden flex-1 px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#f0474a]">
                            Previous
                        </button>
                        <button type="button" id="nextButton"
                                class="flex-1 px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[#f0474a] hover:bg-[#e43d40] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#f0474a]">
                            Next
                        </button>
                        <button type="submit" id="signupButton"
                                class="hidden flex-1 px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[#f0474a] hover:bg-[#e43d40] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#f0474a]">
                            <span>Sign up</span>
                            <i class="fas fa-spinner loading ml-2 hidden"></i>
                        </button>
                    </div>
                </div>
            </form>

            <!-- Divider and Google Sign In -->
            <div class="mt-10">
                <div class="relative flex items-center mb-4">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="mx-4 text-sm text-gray-500 bg-white px-2">Or continue with</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>
                <button id="googleSignIn" 
                        class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 shadow-sm rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#f0474a]">
                    <i class="fab fa-google mr-2"></i>
                    Sign up with Google
                </button>
            </div>

            <!-- Sign In Link -->
            <div class="mt-8">
                <p class="text-center text-sm text-gray-600">
                    Already have an account?
                    <a href="login.html" class="font-medium text-[#f0474a] hover:underline">Sign in</a>
                </p>
            </div>
        </div>
    </div>

    <script>
        // Form navigation
        let currentStep = 1;
        const totalSteps = 4;
        
        const formSteps = document.querySelectorAll('.form-step');
        const stepIndicators = document.querySelectorAll('.step-indicator');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');

        // Password visibility toggle
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Validate current step
        function validateStep(step) {
            const currentForm = document.querySelector(`#step${step}`);
            const inputs = currentForm.querySelectorAll('input[required], select[required], textarea[required]');
            let isValid = true;

            inputs.forEach(input => {
                if (!input.checkValidity()) {
                    isValid = false;
                    input.classList.add('border-red-500');
                    // Show error message
                    const errorMsg = input.nextElementSibling?.classList.contains('error-message') 
                        ? input.nextElementSibling 
                        : document.createElement('p');
                    
                    if (!input.nextElementSibling?.classList.contains('error-message')) {
                        errorMsg.classList.add('error-message', 'text-red-500', 'text-sm', 'mt-1');
                        input.parentNode.insertBefore(errorMsg, input.nextSibling);
                    }
                    errorMsg.textContent = input.validationMessage;
                } else {
                    input.classList.remove('border-red-500');
                    const errorMsg = input.nextElementSibling;
                    if (errorMsg?.classList.contains('error-message')) {
                        errorMsg.remove();
                    }
                }
            });

            // Special validation for password confirmation
            if (step === 1) {
                const password = document.getElementById('password');
                const confirmPassword = document.getElementById('confirm_password');
                if (password.value !== confirmPassword.value) {
                    isValid = false;
                    confirmPassword.classList.add('border-red-500');
                    const errorMsg = confirmPassword.nextElementSibling?.classList.contains('error-message')
                        ? confirmPassword.nextElementSibling
                        : document.createElement('p');
                    
                    if (!confirmPassword.nextElementSibling?.classList.contains('error-message')) {
                        errorMsg.classList.add('error-message', 'text-red-500', 'text-sm', 'mt-1');
                        confirmPassword.parentNode.insertBefore(errorMsg, confirmPassword.nextSibling);
                    }
                    errorMsg.textContent = 'Passwords do not match';
                }
            }

            return isValid;
        }

        function updateFormSteps() {
            formSteps.forEach((step, index) => {
                if (index + 1 === currentStep) {
                    step.classList.remove('hidden');
                } else {
                    step.classList.add('hidden');
                }
            });

            // Update step indicators
            stepIndicators.forEach((indicator, index) => {
                if (index + 1 <= currentStep) {
                    indicator.classList.remove('bg-gray-300');
                    indicator.classList.add('bg-[#f0474a]');
                } else {
                    indicator.classList.remove('bg-[#f0474a]');
                    indicator.classList.add('bg-gray-300');
                }
            });

            // Update navigation buttons
            prevButton.classList.toggle('hidden', currentStep === 1);
            nextButton.classList.toggle('hidden', currentStep === totalSteps);
            signupButton.classList.toggle('hidden', currentStep !== totalSteps);
        }

        nextButton.addEventListener('click', () => {
            if (validateStep(currentStep)) {
                if (currentStep < totalSteps) {
                    currentStep++;
                    updateFormSteps();
                }
            }
        });

        prevButton.addEventListener('click', () => {
            if (currentStep > 1) {
                currentStep--;
                updateFormSteps();
            }
        });

        // Clear validation styling when input changes
        document.querySelectorAll('input, select, textarea').forEach(input => {
            input.addEventListener('input', () => {
                input.classList.remove('border-red-500');
                const errorMsg = input.nextElementSibling;
                if (errorMsg?.classList.contains('error-message')) {
                    errorMsg.remove();
                }
            });
        });

        // Use centralized Supabase client
        const supabase = window.supabase;

        // Elements
        const signupForm = document.getElementById('signupForm');
        const signupButton = document.getElementById('signupButton');
        const googleSignIn = document.getElementById('googleSignIn');
        const messageArea = document.getElementById('messageArea');
        const loadingIcon = signupButton.querySelector('.loading');

    // Initialize visible step AFTER we have element references
    updateFormSteps();

        // Helper Functions
        function showMessage(message, isError = true) {
            messageArea.textContent = message;
            messageArea.classList.remove('hidden', 'text-red-600', 'text-green-600');
            messageArea.classList.add(isError ? 'text-red-600' : 'text-green-600');
        }

        function hideMessage() {
            messageArea.classList.add('hidden');
        }

        function setLoading(isLoading) {
            loadingIcon.classList.toggle('hidden', !isLoading);
            signupButton.disabled = isLoading;
            googleSignIn.disabled = isLoading;
        }

        // Email/Password Sign Up
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validate all steps before submission
            for (let i = 1; i <= totalSteps; i++) {
                if (!validateStep(i)) {
                    currentStep = i;
                    updateFormSteps();
                    return;
                }
            }
            
            hideMessage();
            setLoading(true);

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

                try {
                    // Get form data
                    const first_name = document.getElementById('first_name').value;
                    const last_name = document.getElementById('last_name').value;
                    const business_name = document.getElementById('business_name').value;
                    const business_description = document.getElementById('business_description').value;
                    const business_category = document.getElementById('business_category').value;
                    const business_location = document.getElementById('business_location').value;
                    const contact_phone = document.getElementById('contact_phone').value;
                    const address = document.getElementById('address').value;
                    const language = document.getElementById('language').value;
                    const profile_image_file = document.getElementById('profile_image').files[0];

                    // Create preferences object
                    const preferences = {
                        language,
                        darkMode: false,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    };

                    // 1. Sign up the user
                const { data: { user, session }, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        emailRedirectTo: window.location.origin + '/eesha selling folder/email-verified.html'
                    }
                });                    if (error) {
                        if (error.message && error.message.includes("already registered")) {
                            throw new Error('A user with this email already exists. Please sign in.');
                        } else {
                            throw error;
                        }
                    }

                    if (!user) {
                        throw new Error('Signup successful but no user returned. Please try logging in.');
                    }

                    // 2. Wait briefly to ensure auth state is established
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    // 3. Get fresh session to confirm auth
                    const { data: { session: currentSession } } = await supabase.auth.getSession();

                    if (!currentSession) {
                        // Store the seller data temporarily
                        const sellerData = {
                            business_name,
                            contact_phone,
                            address
                        };
                        localStorage.setItem('pendingSellerData', JSON.stringify(sellerData));

                        showMessage('Please check your email for a verification link. After verifying, you can log in.', false);
                        signupForm.reset();
                        
                        // After 2 seconds, redirect to login page
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                        return; // Exit early since we need email verification
                    }

                    // 4. Create seller profile with authenticated session
                    try {
                        // Debug: Log the current user ID
                        const { data: { user: currentUser } } = await supabase.auth.getUser();
                        console.log('Current user ID:', currentUser?.id);
                        console.log('Attempting to create seller profile with ID:', user.id);

                        // First, upload the profile image if one was selected
                        let profile_image_url = null;
                        if (profile_image_file) {
                            try {
                                // Create a bucket for the profile image if it doesn't exist
                                const { data: bucketData, error: bucketError } = await supabase.storage
                                    .getBucket('seller-profiles');
                                
                                if (bucketError && bucketError.statusCode === 404) {
                                    await supabase.storage.createBucket('seller-profiles', {
                                        public: true,
                                        fileSizeLimit: 1024 * 1024 * 2 // 2MB limit
                                    });
                                }

                                // Create a unique filename
                                const timestamp = new Date().getTime();
                                const fileExt = profile_image_file.name.split('.').pop();
                                const fileName = `${currentUser.id}_${timestamp}.${fileExt}`;
                                
                                // Upload the file
                                const { data: uploadData, error: uploadError } = await supabase.storage
                                    .from('seller-profiles')
                                    .upload(fileName, profile_image_file, {
                                        cacheControl: '3600',
                                        upsert: false,
                                        contentType: `image/${fileExt}`
                                    });

                                if (uploadError) {
                                    console.error('Upload error:', uploadError);
                                    throw new Error(`Failed to upload profile image: ${uploadError.message}`);
                                }

                                // Get the public URL
                                const { data: { publicUrl } } = supabase.storage
                                    .from('seller-profiles')
                                    .getPublicUrl(fileName);

                                profile_image_url = publicUrl;
                            } catch (error) {
                                console.error('Profile image upload error:', error);
                                showMessage('Warning: Could not upload profile image. Continuing with signup...', false);
                                // Continue with signup even if image upload fails
                            }
                        }

                        // Get the current user's email
                        const { data: { user: { email: userEmail } } } = await supabase.auth.getUser();

                        // Create the seller profile with all fields
                        const { data: sellerData, error: sellerError } = await supabase
                            .from('sellers')
                            .insert([
                                {
                                    id: currentUser.id, // Use the authenticated user's ID
                                    first_name,
                                    last_name,
                                    email: userEmail, // Use the authenticated email
                                    phone: contact_phone,
                                    business_name,
                                    business_description,
                                    business_category,
                                    business_location,
                                    profile_image: profile_image_url,
                                    preferences: {
                                        language: language || 'en',
                                        darkMode: false,
                                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                                    },
                                    status: 'active',
                                    address,
                                    contact_phone
                                }
                            ])
                            .select();

                        if (sellerError) {
                            console.error('Detailed seller error:', sellerError);
                            throw new Error(`Failed to create seller profile: ${sellerError.message}`);
                        }

                        if (!sellerData || sellerData.length === 0) {
                            throw new Error('Seller profile was not created properly');
                        }

                        console.log('Successfully created seller profile:', sellerData[0]);

                        // Success!
                        showMessage('Sign-up successful! Redirecting to dashboard...', false);
                        signupForm.reset();
                        
                        // 5. Redirect to dashboard after a brief delay
                        setTimeout(() => {
                            window.location.href = 'Seller-index.html';
                        }, 1500);

                    } catch (error) {
                        console.error('Error in signup process:', error);
                        
                        // If seller profile creation fails, attempt to clean up
                        try {
                            const { error: signOutError } = await supabase.auth.signOut();
                            if (signOutError) {
                                console.error('Error during sign out:', signOutError);
                            }
                            
                            // Show a user-friendly error message
                            if (error.message.includes('profile image')) {
                                showMessage('Failed to upload profile image. Please try again with a different image or skip the profile image for now.');
                            } else {
                                showMessage('Failed to create seller profile. Please try again or contact support if the problem persists.');
                            }
                        } catch (cleanupError) {
                            console.error('Error during cleanup:', cleanupError);
                            showMessage('Account creation failed. Please contact support.');
                        }
                    }
                } catch (error) {
                    console.error('Signup error:', error);
                    showMessage(error.message || 'Failed to sign up. Please try again.');
                } finally {
                    setLoading(false);
                }
        });

        // Google Sign Up
        googleSignIn.addEventListener('click', async () => {
            hideMessage();
            
            try {
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin + '/eesha selling folder/Seller-index.html'
                    }
                });

                if (error) throw error;

                // The seller profile will be created when the user is redirected back
                supabase.auth.onAuthStateChange(async (event, session) => {
                    if (event === 'SIGNED_IN' && session?.user) {
                        try {
                            // Check if seller profile exists
                            const { data: existingSeller } = await supabase
                                .from('sellers')
                                .select('id')
                                .eq('id', session.user.id)
                                .single();

                            if (!existingSeller) {
                                // Create seller profile
                                await supabase
                                    .from('sellers')
                                    .insert([
                                        {
                                            id: session.user.id,
                                            created_at: new Date().toISOString(),
                                            status: 'active'
                                        }
                                    ]);
                            }
                            
                            window.location.href = 'Seller-index.html';
                        } catch (profileError) {
                            console.error('Error creating seller profile:', profileError);
                            showMessage('Failed to create seller profile. Please contact support.');
                        }
                    }
                });
            } catch (error) {
                showMessage('Failed to sign up with Google');
            }
        });
    </script>
</body>
</html>